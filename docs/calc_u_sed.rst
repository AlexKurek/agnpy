.. _calc_u_sed:

===========================================================================
Calculations of Energy Densities of Photon Targets and Inverse Compton SEDs
===========================================================================
In this section we collect the formulas that are implemented in :py:mod:`~agnpy.targets`
and :py:mod:`~agnpy.compton` to compute the energy densities (:math:`u`) of the
target photon fields and the SEDs (:math:`\nu F_{\nu}`) generated by their Inverse 
Compton scattering.    
I leave most of the passages explicit hoping it is easier for the interested reader 
to follow and to check the correctnes of the formulas.

Energy densities :math:`u`
==========================
The integrated energy densities :math:`u\,[\uunits]` for the different photon 
fields are computed both in a stationary reference frame whose 
origin coincides with the galaxy Black Hole and in a reference frame comoving 
with the Blob, which is streaming along the jet with velocity :math:`\Beta` and 
Lorentz factor :math:`\Gamma`.   

Notation
--------
Differential quantities are implicit, i.e. 

.. math::
    X(x_1, x_2; y) = \frac{\partial X}{\partial x_1 \, \partial x_2}(y),

where after the ; we specify parameters. We aim to calculate the integral energy 
density, of a given photon field, i.e. 

.. math::
    u(r) = \int\diff\epsilon \int\diff\Omega \; u(\epsilon, \Omega; r),

where
:math:`u(\epsilon, \Omega; r) =  \frac{\partial u}{\partial \epsilon  \, \partial \Omega}(r)`
is the differential energy density, :math:`\epsilon = E / (m_e c^2)` is the dimensionless 
energy of the photon (in units of the electron rest mass), :math:`\Omega = (\mu, \phi)` 
is the solid angle and :math:`r` specifies the distance of the blob along the jet axis. 

Transformations
---------------
Quantities specified in the Blob comoving frame are primed. We recall the following 
energy and cosine transformations, from the stationary 
to the comoving frame: 

.. math::
    \epsilon' &= \Gamma \epsilon (1 - \Beta \mu), \\
    \mu' &= \frac{\mu - \Beta}{1 - \Beta \mu};
    :label: boost_stat_to_com

and viceversa from the comoving to the stationary

.. math::
    \epsilon &= \Gamma \epsilon' (1 + \Beta \mu'), \\
    \mu &= \frac{\mu' + \Beta}{1 + \Beta \mu'}.
    :label: boost_com_to_stat

It can be proved [Dermer2002]_ that the quantity :math:`u(\epsilon, \Omega)/\epsilon^3` 
is a relativistic invariant, from which it follows

.. math::
    u'(\epsilon', \Omega') = \frac{u(\epsilon, \Omega)}{\utransform}.
    :label: u_stat_to_com



Isotropic Monochromatic
-----------------------
Let us consider an isotropic monochromatic (:math:`\epsilon_0`) radiation field with 
energy density :math:`u_0\,/\,\uunits`,

.. math::
    u(\epsilon, \Omega) = \frac{u_0\,\delta(\epsilon - \epsilon_0)}{4 \pi}

**Galaxy Frame**

.. math::
    u = \int_{0}^{\infty}\diff\epsilon\;
        \int_{0}^{2\pi}\diff\phi\;
        \int_{-1}^{1}\diff\mu\; u(\epsilon, \Omega) = u_0. 

**Comoving Frame**

.. math::
    u' &= \int_{0}^{\infty}\diff\epsilon'\;
            \int_{0}^{2\pi}\diff\phi'\;
            \int_{-1}^{1}\diff\mu'\; 
            \frac{u_0\,\delta(\epsilon - \epsilon_0)}{4 \pi}\,
            \frac{1}{\utransform} \\
        &= 2\pi \int_{0}^{\infty} \frac{\diff \epsilon}{\Gamma (1 + \Beta\mu')}\;
            \int_{-1}^{1}\diff\mu'\; 
            \frac{u_0\,\delta(\epsilon - \epsilon_0)}{4 \pi}\,
            \frac{1}{\utransform} \\
        &= \frac{u_0}{2 \Gamma^4}\int_{-1}^{1}\diff\mu'\;
            \frac{1}{(1 + \Beta\mu')^4} 
        = \frac{u_0}{2 \Gamma^4} 
            \left[ - \frac{1}{3\Beta (1 + \Beta\mu')^3}\right]_{-1}^{1} \\
        &= \frac{u_0}{2 \Gamma^4} 
            \left[\frac{(1 + \Beta)^3 - (1 - \Beta)^3}{3 \Beta \Gamma^{-6}}\right] 
        = \boxed{u_0\,\Gamma^2 \left(1 + \frac{\Beta^2}{3}\right).}

And we have reobtained the result in Eq. 5 of [Dermer1994]_ and Eq. 10 of 
[Dermer2002]_.


Monochromatic Point Source Behind the Jet
-----------------------------------------
Let us consider a source of luminosity :math:`L_0` at a distance :math:`r` from the jet,

.. math::
    u(\epsilon, \Omega; r) = \frac{L_0}{4 \pi c r^2} \frac{\delta(\mu-1)}{2 \pi} \delta(\epsilon - \epsilon_0)

where we label :math:`u_0 = \frac{L_0}{4 \pi c r^2}` for convenience.

**Galaxy Frame**

.. math::
    u = \int_{0}^{\infty}\diff\epsilon\;
        \int_{0}^{2\pi}\diff\phi\;
        \int_{-1}^{1}\diff\mu\; u_0 \frac{\delta(\mu-1)}{2 \pi} \delta(\epsilon - \epsilon_0) = u_0
        \left( = \frac{L_0}{4 \pi c r^2} \right), 
    :label: point_source_stat

where the normalisation :math:`2\pi` cancels out the result of the integration in 
:math:`\diff\phi` and the delta in :math:`\mu` removes the integration in :math:`\mu`.

**Comoving Frame**

.. math::    
    u' = \int_{0}^{\infty}\diff\epsilon'\;
         \int_{0}^{2\pi}\diff\phi'\;
         \int_{-1}^{1}\diff\mu'\; 
          u_0 \frac{\delta(\mu-1)}{2 \pi} \delta(\epsilon - \epsilon_0)\,
         \frac{1}{\utransform},

Now we convert the differentials in :math:`\epsilon'` and :math:`\mu'` in :math:`\epsilon` and :math:`\mu`, 
in order to simplify them with the deltas. We note that from Eq. :eq:`boost_stat_to_com`

.. math::
    \frac{\diff\mu'}{\diff\mu} = \frac{(1 - \Beta\mu) + (\mu - \Beta)\Beta}{(1 - \Beta\mu)^2} 
    \Rightarrow \diff\mu' = \frac{1}{\Gamma^2 (1 - \Beta\mu)^2} \diff\mu,

therefore

.. math::
    u' &= 2\pi \int_{0}^{\infty} \frac{\diff \epsilon}{\Gamma (1 + \Beta\mu')}\;
            \int_{-1}^{1}\frac{\diff\mu}{\Gamma^2 (1 - \Beta\mu)^2}\; 
            \frac{u_0}{2\pi} \delta(\epsilon - \epsilon_0) \delta(\mu - 1)\,
            \frac{1}{\utransform} \\
        &= \frac{u_0}{\Gamma^6} \int_{-1}^{1} \frac{\diff\mu}{(1 - \Beta\mu)^2(1 + \Beta\mu')^4}\;
            \delta(\mu - 1) \\
        &= \frac{u_0}{\Gamma^6} \frac{1}{(1 - \Beta)^2(1 + \Beta)^4} 
        = \boxed{\frac{u_0}{\Gamma^2 (1 + \Beta)^2}},   
    :label: point_source_com

where in the penultimate equality we have used :math:`\mu = 1 \Rightarrow \mu'=1` 
from Eq. :eq:`boost_stat_to_com` and the condition imposed by the dirac delta.
We have reobtained Eq. 6 of [Dermer1994]_.
**NOTE** we will use Eq. :eq:`point_source_stat` and :eq:`point_source_com` 
as a crosscheck for the radiation fields of more complicate objects 
(for distances much larger than their dimensions they should appear as a point 
source behind the jet).

Shakura Sunyaev Disk
--------------------

.. _compton_disk:
.. figure:: _static/compton_disk.pdf
    :width: 400px
    :align: center

The differential energy density for a geometrically thin optically thick Shakura 
Sunyaev accretion disk reads

.. math::
    u(\epsilon, \Omega; r) = \frac{3}{(4 \pi)^2 c} 
    \frac{G M \dot{m}}{R^3 \mu}
    \varphi(R) \, \delta(\epsilon - \bar{\epsilon}(R))

from Eq. 25 in [Dermer2002]_. :math:`\varphi(R)` represents the variation of 
radiant surface energy flux along the radius

.. math::
    \varphi(R) = 1 - \sqrt{\frac{R_{\rm in}}{R}}
    :label: phi_R
    
and :math:`\bar{\epsilon}(R)` the monochromatic approximation for the photon energy 
emitted from the disk at radius :math:`R`

.. math::
    \bar{\epsilon}(R) = 2.7 \times 10^{-4} \left(\frac{l_{\rm Edd}}{M_8 \eta}\right)^{1/4} 
    \left(\frac{R}{R_g}\right)^{-3/4}.
    :label: epsilon_R

In the above equations :math:`M` is the mass of the Black Hole (:math:`M_8` the 
same quantity expressed in :math:`10^8\,M_{\odot}` units), :math:`\dot{m}` is the 
BH mass accretion rate, :math:`\eta` the fraction of gravitational energy converted 
to radiant energy, :math:`l_{\rm Edd}` the fraction of the disk luminosity to the 
Eddington luminosity, :math:`R_g` the gravitational radius. The geometry of the 
problem is illustrated in Figure :numref:`compton_disk`. Notice that

.. math::
    R = r \sqrt{\mu^{-2} - 1}
    :label: R_from_mu_r

and the maximum and minimum cosine angles under which the disk is viewed at the 
distance :math:`r`, are

.. math::
    \mu_{\rm min} &= \frac{1}{\sqrt{1 + \frac{R^2_{\rm out}}{r^2}}}, \\ 
    \mu_{\rm max} &= \frac{1}{\sqrt{1 + \frac{R^2_{\rm in}}{r^2}}}

where :math:`R_{\rm in}` and :math:`R_{\rm out}` are inner and outer radiuses of 
the disk, respectively. Note that given Eq. :eq:`R_from_mu_r` we can write 
Eq. :eq:`phi_R` and :eq:`epsilon_R` as :math:`\varphi(\mu, r)` and 
:math:`\bar{\epsilon}(\mu, r)`.

**Galaxy Frame**

.. math::
    u &= \int_{0}^{\infty}\diff\epsilon\;
            \int_{0}^{2\pi}\diff\phi\;
            \int_{\mu_{\rm min}}^{\mu_{\rm max}}\diff\mu\;
            \frac{3}{(4 \pi)^2 c} 
            \frac{G M \dot{m}}{R^3 \mu}
            \varphi(R) \, \delta(\epsilon - \bar{\epsilon}(R)) \\
        &= \frac{3}{8 \pi c} \frac{G M \dot{m}}{r^3} 
            \int_{\mu_{\rm min}}^{\mu_{\rm max}}\diff\mu\;
            \frac{\varphi(\mu)}{\mu(\mu^{-2} - 1)^{3/2}}.
    :label: ssdisk_stat

**Comoving Frame**

.. math::
    u' &= \int_{0}^{\infty}\diff\epsilon'\;
            \int_{0}^{2\pi}\diff\phi'\;
            \int_{\mu'_{\rm min}}^{\mu'_{\rm max}}\diff\mu'\; 
            \frac{3}{(4 \pi)^2 c} 
            \frac{G M \dot{m}}{R^3 \mu}
            \varphi(R)
            \delta(\epsilon - \bar{\epsilon}(R))
            \frac{1}{\utransform} \\
        &= \frac{3}{8 \pi c} \frac{G M \dot{m}}{r^3}
            \int_{0}^{\infty}\frac{\diff \epsilon}{\Gamma (1 + \Beta\mu')}\;
            \int_{\mu_{\rm min}}^{\mu_{\rm max}}\frac{\diff\mu}{\Gamma^2 (1 - \Beta\mu)^2}\;
            \frac{\varphi(\mu, r)}{\mu(\mu^{-2} - 1)^{-3/2}}
            \frac{\delta(\epsilon - \bar{\epsilon}(\mu, r))}{\utransform} \\
        &= \frac{3}{8 \pi c} \frac{G M \dot{m}}{r^3}
            \int_{\mu_{\rm min}}^{\mu_{\rm max}}\diff\mu\;
            \frac{\varphi(\mu, r)}{\Gamma^6 (1 - \Beta\mu)^2 (1 + \Beta \mu')^4 \mu(\mu^{-2} - 1)^{-3/2}}.
    :label: ssdisk_com

Both these equations cannot be simplified analytically, we can check numerically,
thorugh the functions implemented in `agnpy` if their limit for large values of 
:math:`r` reduces to the case of point source behind the jet, i.e. Eq. 
:eq:`point_source_com` and :eq:`point_source_stat`.


Spherical Shell Broad Line Region
---------------------------------

.. _compton_reprocessed:
.. figure:: _static/compton_reprocessed.pdf
    :width: 400px
    :align: center

Let us consider the BLR as a monochromatic (:math:`\epsilon_{\rm li}`) infinitesimally 
thin (:math:`R_{\rm li}`) shell, as in [Finke2016]_

.. math::
    u(\epsilon, \Omega; r) = \frac{\xi_{\rm li} L_{\rm disk}}{(4\pi)^2c} 
    \delta(\epsilon - \epsilon_{\rm li}) 
    \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{x^2} \delta(\mu - \mu_*),
    
where

.. math::        
        \mu_*^2 &= 1 - \left( \frac{R_{\rm li}}{x} \right)^2 (1 - \mu_{\rm re}^2), \\
            x^2 &= R_{\rm li}^2 + r^2 - 2 r  R_{\rm li} \mu_{\rm re},

and the geometry of the reprocessing material is illustrated in :numref:`compton_reprocessed`.

**Galaxy Frame**

.. math::
    u &= \int_{0}^{\infty}\diff\epsilon\;
            \int_{0}^{2\pi}\diff\phi\;
            \int_{-1}^{1}\diff\mu\;
            \frac{\xi_{\rm li} L_{\rm disk}}{(4\pi)^2c} 
            \delta(\epsilon - \epsilon_{\rm li}) 
            \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{x^2} \delta(\mu - \mu_*) \\
        &= \frac{\xi_{\rm li} L_{\rm disk}}{8 \pi c} \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{x^2}.
    :label: blr_stat

Let us examine if for large distances (:math:`r \gg R_{\rm li}`) Eq. :eq:`blr_stat` 
:math:`\rightarrow` :eq:`point_source_stat`, i.e. if the BLR appears as a point 
source behind the jet. Since :math:`x \xrightarrow[r \gg R_{\rm li}]{} r`, we have

.. math::
    u = \frac{\xi_{\rm li} L_{\rm disk}}{8 \pi c} \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{r^2} 
      = \frac{\xi_{\rm li} L_{\rm disk}}{4 \pi c r^2},

which is :eq:`point_source_stat`, i.e. the energy density of a monochromatic 
point source behind the jet, with :math:`u_0 = \frac{\xi_{\rm li} L_{\rm disk}}{4 \pi c r^2}` 
(:math:`L_0 = \xi_{\rm li} L_{\rm disk}`).

**Comoving Frame**

.. math::
    u' &= \int_{0}^{\infty}\diff\epsilon'\;
            \int_{0}^{2\pi}\diff\phi'\;
            \int_{-1}^{1}\diff\mu'\; 
            \frac{\xi_{\rm li} L_{\rm disk}}{(4\pi)^2c} 
            \delta(\epsilon - \epsilon_{\rm li}) 
            \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{x^2} \delta(\mu - \mu_*) 
            \frac{1}{\utransform} \\
        &= 2\pi \int_{0}^{\infty} \frac{\diff \epsilon}{\Gamma (1 + \Beta\mu')}\;
            \int_{-1}^{1}\frac{\diff\mu}{\Gamma^2 (1 - \Beta\mu)^2}\;
            \frac{\xi_{\rm li} L_{\rm disk}}{(4\pi)^2c} 
            \delta(\epsilon - \epsilon_{\rm li}) 
            \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{x^2} \delta(\mu - \mu_*) 
            \frac{1}{\utransform} \\
        &= \frac{\xi_{\rm li} L_{\rm disk}}{8 \pi c}
            \int_{-1}^{1} \frac{\diff\mu}{\Gamma^2 (1 - \Beta\mu)^2 \Gamma^4 (1 + \Beta\mu')^4}
            \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{x^2} \delta(\mu - \mu_*), 

using the delta condition :math:`\mu = \mu_* \Rightarrow \mu' = \frac{\mu_* - \Beta}{1 - \Beta \mu_*}`.
The latter in turns imply :math:`1 + \Beta\mu' = \frac{1}{\Gamma^2 (1 - \Beta\mu_*)}`, 
therefore

.. math::        
    u' &= \frac{\xi_{\rm li} L_{\rm disk}}{8 \pi c}
          \frac{\Gamma^8 (1 - \Beta\mu_*)^4}{\Gamma^6 (1 - \Beta\mu_*)^2}
          \int_{-1}^{1}\frac{\diff\mu_{\rm re}}{x^2} \\
        &= \frac{\xi_{\rm li} L_{\rm disk}}{8 \pi c}
           \int_{-1}^{1} \Gamma^2 (1 - \Beta\mu_*)^2
           \frac{\diff\mu_{\rm re}}{x^2}. 
    :label: blr_com

If the calculation was done correctly, in the limit of large distances (:math:`r \gg R_{\rm li}`)
:eq:`blr_com` :math:`rightarrow` :eq:`point_source_com`, i.e. the BLR 
should appear as a point source behind the jet (also in the comoving frame).
For :math:`r \gg R_{\rm li}`, :math:`x^2 \rightarrow r^2` and 
:math:`\mu_* \rightarrow 1`, so

.. math::
    u' = \Gamma^2 (1 - \Beta)^2 \frac{\xi_{\rm li} L_{\rm disk}}{8 \pi c}
         \frac{2}{r^2} = \frac{\Gamma^2 (1 - \Beta^2)^2}{(1 + \Beta)^2} 
         \frac{\xi_{\rm li} L_{\rm disk}}{4 \pi c r^2} 
       = \frac{1}{\Gamma^2 (1 + \Beta)^2} 
         \frac{\xi_{\rm li} L_{\rm disk}}{4 \pi c r^2}.

where in the penultimate equality we have multiplied and divided by $(1 + \Beta)^2$.
We have reobtained \refeq{eq:point_source_com} with 
:math:`u_0 = \frac{\xi_{\rm li} L_{\rm disk}}{4 \pi c r^2}` 
(:math:`L_0 = \xi_{\rm li} L_{\rm disk}`).
